---
phase: 03-server-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/server/__init__.py
  - backend/server/models.py
  - backend/server/netdata.py
  - backend/server/routes.py
  - backend/config.py
  - backend/main.py
autonomous: true

must_haves:
  truths:
    - "API returns CPU percentage from Netdata"
    - "API returns RAM usage from Netdata"
    - "API returns disk usage from Netdata"
    - "API returns network I/O from Netdata"
    - "Metrics include historical data points for sparklines"
    - "Time range parameter controls data window (5m, 1h, 24h)"
  artifacts:
    - path: "backend/server/__init__.py"
      provides: "Server module exports"
    - path: "backend/server/models.py"
      provides: "MetricData, MetricPoint, TimeRange models"
      contains: "class MetricData"
    - path: "backend/server/netdata.py"
      provides: "Netdata API client wrapper"
      exports: ["fetch_metric", "get_system_metrics"]
    - path: "backend/server/routes.py"
      provides: "Server metrics endpoints"
      contains: "@router.get"
  key_links:
    - from: "backend/server/routes.py"
      to: "backend/server/netdata.py"
      via: "import and call fetch_metric"
      pattern: "from backend.server.netdata import"
    - from: "backend/server/netdata.py"
      to: "http://127.0.0.1:19999"
      via: "httpx async client"
      pattern: "httpx.AsyncClient"
    - from: "backend/main.py"
      to: "backend/server/routes.py"
      via: "router include"
      pattern: "include_router.*server_router"
---

<objective>
Create backend Netdata API integration to proxy metrics from local Netdata instance.

Purpose: Provide authenticated access to server metrics (CPU, RAM, disk, network) through the dashboard API, with time-range support for sparkline visualization.

Output: Working `/api/v1/server/metrics` endpoint returning metric data from Netdata.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-server-dashboard/03-RESEARCH.md
@.planning/phases/03-server-dashboard/03-CONTEXT.md

# Existing patterns
@backend/wordops/models.py
@backend/wordops/routes.py
@backend/config.py
@backend/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server module with Netdata client</name>
  <files>
    backend/server/__init__.py
    backend/server/models.py
    backend/server/netdata.py
    backend/config.py
  </files>
  <action>
Create new `backend/server/` module following existing wordops module structure.

**models.py:**
- `TimeRange` enum: `FIVE_MIN = "5m"`, `ONE_HOUR = "1h"`, `ONE_DAY = "24h"`
- `MetricPoint` model: `timestamp: int`, `value: float`
- `MetricData` model: `name: str`, `current: float`, `unit: str`, `points: list[MetricPoint]`
- `SystemMetrics` model: `cpu: MetricData`, `ram: MetricData`, `disk: MetricData`, `network_in: MetricData`, `network_out: MetricData`

**netdata.py:**
- `NETDATA_URL` constant from config (default `http://127.0.0.1:19999`)
- Time range mapping: 5m=-300, 1h=-3600, 24h=-86400
- Points mapping: 5m=60, 1h=60, 24h=144 (reasonable sparkline resolution)
- `async def fetch_metric(context: str, time_range: TimeRange) -> MetricData` - fetches from Netdata API v3
- `async def get_system_metrics(time_range: TimeRange) -> SystemMetrics` - fetches all core metrics
- Use httpx.AsyncClient with 5s timeout
- Contexts to fetch: `system.cpu`, `system.ram`, `system.io`, `system.net`
- Handle connection errors gracefully (Netdata may not be running)

**config.py:**
- Add `NETDATA_URL: str = "http://127.0.0.1:19999"` to Settings

**__init__.py:**
- Export models and key functions
  </action>
  <verify>
python -c "from backend.server.models import MetricData, TimeRange, SystemMetrics; print('Models OK')"
python -c "from backend.server.netdata import fetch_metric, get_system_metrics; print('Netdata client OK')"
  </verify>
  <done>Server module exists with Netdata client that can fetch metrics from local Netdata API</done>
</task>

<task type="auto">
  <name>Task 2: Create metrics API endpoints</name>
  <files>
    backend/server/routes.py
    backend/main.py
  </files>
  <action>
**routes.py:**
Create router with prefix `/api/v1/server` and tag `server`.

Endpoint: `GET /api/v1/server/metrics`
- Query param: `range: TimeRange = TimeRange.FIVE_MIN`
- Requires authentication (use `get_current_user` dependency)
- Returns: `SystemMetrics` model
- Calls `get_system_metrics(range)`
- Error handling:
  - Return 503 if Netdata unreachable (httpx.ConnectError)
  - Return 503 if Netdata returns error (httpx.HTTPStatusError)

Follow existing routes.py patterns from wordops module:
- Same import style
- Same HTTPException patterns
- Same docstring format

**main.py:**
- Import `from backend.server.routes import router as server_router`
- Add `app.include_router(server_router)` after sites_router
  </action>
  <verify>
# Start server (if not running):
# cd /home/william/Projects/WordOps-Dashboard && uvicorn backend.main:app --reload &

# Test endpoint (will return 503 if Netdata not running, which is expected):
curl -s http://localhost:8000/api/v1/server/metrics -H "Authorization: Bearer ${TOKEN}" | head -20

# Verify route registered:
curl -s http://localhost:8000/openapi.json | python -c "import sys,json; paths=json.load(sys.stdin)['paths']; print('/api/v1/server/metrics' in paths)"
  </verify>
  <done>Metrics endpoint returns SystemMetrics JSON (or 503 if Netdata unavailable). Route visible in OpenAPI schema.</done>
</task>

</tasks>

<verification>
1. Server module structure: `ls backend/server/` shows __init__.py, models.py, netdata.py, routes.py
2. Models importable: `python -c "from backend.server.models import SystemMetrics"`
3. Netdata client importable: `python -c "from backend.server.netdata import get_system_metrics"`
4. Route registered: OpenAPI schema includes `/api/v1/server/metrics`
5. Endpoint requires auth: `curl http://localhost:8000/api/v1/server/metrics` returns 401
</verification>

<success_criteria>
- New `backend/server/` module with models, netdata client, and routes
- GET /api/v1/server/metrics endpoint registered and requires authentication
- Endpoint returns SystemMetrics with CPU, RAM, disk, network data when Netdata available
- Endpoint returns 503 with descriptive error when Netdata unavailable
- Time range parameter accepted (5m, 1h, 24h)
</success_criteria>

<output>
After completion, create `.planning/phases/03-server-dashboard/03-01-SUMMARY.md`
</output>
