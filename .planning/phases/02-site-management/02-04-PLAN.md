---
phase: 02-site-management
plan: 04
type: execute
wave: 4
depends_on: ["02-03"]
files_modified: [backend/wordops/sites.py, backend/wordops/models.py, backend/wordops/routes.py]
autonomous: true

must_haves:
  truths:
    - "Authenticated user can update a site via PUT /api/v1/sites/{domain}"
    - "Site update can toggle SSL, change cache, or change PHP version"
    - "Authenticated user can delete a site via DELETE /api/v1/sites/{domain}"
    - "Site deletion requires confirmation flag to prevent accidents"
    - "Invalid domain format returns 400 Bad Request"
    - "Non-existent site returns 404 Not Found"
  artifacts:
    - path: "backend/wordops/sites.py"
      provides: "update_site() and delete_site() async functions"
      contains: "async def update_site"
    - path: "backend/wordops/models.py"
      provides: "UpdateSiteRequest Pydantic model"
      contains: "class UpdateSiteRequest"
    - path: "backend/wordops/routes.py"
      provides: "PUT and DELETE endpoints"
      contains: "@router.put"
  key_links:
    - from: "backend/wordops/routes.py"
      to: "backend/wordops/sites.py"
      via: "import update_site, delete_site"
      pattern: "from backend\\.wordops\\.sites import.*update_site"
    - from: "backend/wordops/sites.py"
      to: "backend/wordops/cli.py"
      via: "run_command for update/delete"
      pattern: "run_command\\(\\[\"site\", \"(update|delete)\""
---

<objective>
Implement site update and delete CLI wrappers and API endpoints.

Purpose: Enable authenticated users to modify site settings (SSL, cache, PHP) and delete sites through the API.

Output: PUT and DELETE `/api/v1/sites/{domain}` endpoints + `update_site()` and `delete_site()` functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-site-management/02-03-SUMMARY.md
@backend/wordops/cli.py
@backend/wordops/sites.py
@backend/wordops/models.py
@backend/wordops/routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create update request model</name>
  <files>backend/wordops/models.py</files>
  <action>
Add UpdateSiteRequest model to backend/wordops/models.py after CreateSiteRequest:

```python
class UpdateSiteRequest(BaseModel):
    """Request body for updating site settings.

    All fields are optional - only provided fields will be updated.
    """

    ssl: bool | None = None           # Enable/disable SSL
    cache: CacheType | None = None    # Change cache type
    php_version: str | None = None    # Change PHP version

    class Config:
        """Pydantic model configuration."""
        use_enum_values = True
```

This model allows partial updates - only the fields provided will be changed.
  </action>
  <verify>
python -c "from backend.wordops.models import UpdateSiteRequest; print('UpdateSiteRequest imported successfully')"
  </verify>
  <done>UpdateSiteRequest model exists with optional ssl, cache, php_version fields</done>
</task>

<task type="auto">
  <name>Task 2: Implement update_site and delete_site CLI wrappers</name>
  <files>backend/wordops/sites.py</files>
  <action>
Add update_site() and delete_site() functions to backend/wordops/sites.py:

1. Update CacheType import if not already done:
   ```python
   from .models import Site, SiteType, CacheType
   ```

2. Add update_site function after create_site():
   ```python
   async def update_site(
       domain: str,
       ssl: bool | None = None,
       cache: CacheType | None = None,
       php_version: str | None = None,
   ) -> Site:
       """
       Update an existing WordOps site.

       Args:
           domain: The domain name of the site
           ssl: Enable (True) or disable (False) SSL, or None to skip
           cache: New cache type, or None to skip
           php_version: New PHP version, or None to skip

       Returns:
           Updated Site object

       Raises:
           ValueError: If domain validation fails or site not found
           CommandFailedError: If update fails
       """
       if not validate_domain(domain):
           raise ValueError(f"Invalid domain name: {domain}")

       # Verify site exists first
       existing = await get_site_info(domain)
       if existing is None:
           raise ValueError(f"Site not found: {domain}")

       # Build update commands - WordOps uses separate commands for different updates
       commands_to_run = []

       # SSL toggle
       if ssl is not None:
           if ssl and not existing.ssl:
               # Enable SSL
               commands_to_run.append(["site", "update", domain, "--letsencrypt"])
           elif not ssl and existing.ssl:
               # Disable SSL (remove letsencrypt)
               commands_to_run.append(["site", "update", domain, "--letsencrypt=off"])

       # Cache change
       if cache is not None:
           cache_flags = {
               CacheType.NONE: "--wpfc=off",  # Disable cache
               CacheType.WPFC: "--wpfc",
               CacheType.WPSC: "--wpsc",
               CacheType.WPREDIS: "--wpredis",
               CacheType.REDIS: "--wpredis",
           }
           if cache in cache_flags:
               commands_to_run.append(["site", "update", domain, cache_flags[cache]])

       # PHP version change
       if php_version is not None:
           if not re.match(r"^\d+\.\d+$", php_version):
               raise ValueError(f"Invalid PHP version format: {php_version}")
           commands_to_run.append(["site", "update", domain, f"--php={php_version}"])

       # Execute all update commands
       for args in commands_to_run:
           await run_command(args, timeout=120)

       # Return updated site info
       updated = await get_site_info(domain)
       return updated if updated else existing
   ```

3. Add delete_site function after update_site():
   ```python
   async def delete_site(domain: str, force: bool = False) -> bool:
       """
       Delete a WordOps site.

       Args:
           domain: The domain name of the site to delete
           force: If True, skip confirmation (required for API)

       Returns:
           True if deletion was successful

       Raises:
           ValueError: If domain validation fails or site not found
           CommandFailedError: If deletion fails
       """
       if not validate_domain(domain):
           raise ValueError(f"Invalid domain name: {domain}")

       # Verify site exists first
       existing = await get_site_info(domain)
       if existing is None:
           raise ValueError(f"Site not found: {domain}")

       # Build delete command
       # --force skips confirmation, --files removes site files
       args = ["site", "delete", domain, "--no-prompt"]
       if force:
           args.append("--files")  # Also remove site files

       await run_command(args, timeout=60)

       return True
   ```
  </action>
  <verify>
python -c "from backend.wordops.sites import update_site, delete_site; print('update_site and delete_site imported successfully')"
  </verify>
  <done>update_site() and delete_site() functions exist with proper parameter handling</done>
</task>

<task type="auto">
  <name>Task 3: Add update and delete endpoints</name>
  <files>backend/wordops/routes.py</files>
  <action>
Add PUT and DELETE endpoints to backend/wordops/routes.py:

1. Update imports:
   ```python
   from backend.wordops.sites import list_sites, get_site_info, validate_domain, create_site, update_site, delete_site
   from backend.wordops.models import Site, SiteType, CreateSiteRequest, UpdateSiteRequest
   ```

2. Add PUT /{domain} endpoint:
   ```python
   @router.put("/{domain}", response_model=Site)
   async def update_existing_site(
       domain: str,
       request: UpdateSiteRequest,
       current_user: User = Depends(get_current_user),
   ) -> Site:
       """Update an existing site's settings.

       Args:
           domain: The domain name of the site
           request: Fields to update (only provided fields are changed)

       Returns:
           Updated site details

       Raises:
           400: Invalid domain or parameters
           404: Site not found
           503: WordOps command failed
       """
       if not validate_domain(domain):
           raise HTTPException(
               status_code=status.HTTP_400_BAD_REQUEST,
               detail=f"Invalid domain format: {domain}",
           )

       try:
           site = await update_site(
               domain=domain,
               ssl=request.ssl,
               cache=request.cache,
               php_version=request.php_version,
           )
           return site
       except ValueError as e:
           error_msg = str(e).lower()
           if "not found" in error_msg:
               raise HTTPException(
                   status_code=status.HTTP_404_NOT_FOUND,
                   detail=str(e),
               )
           raise HTTPException(
               status_code=status.HTTP_400_BAD_REQUEST,
               detail=str(e),
           )
       except Exception as e:
           raise HTTPException(
               status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
               detail=f"Site update failed: {str(e)}",
           )
   ```

3. Add DELETE /{domain} endpoint:
   ```python
   @router.delete("/{domain}", status_code=status.HTTP_204_NO_CONTENT)
   async def delete_existing_site(
       domain: str,
       confirm: bool = Query(..., description="Must be true to confirm deletion"),
       current_user: User = Depends(get_current_user),
   ) -> None:
       """Delete a site permanently.

       Args:
           domain: The domain name of the site to delete
           confirm: Must be true to confirm deletion (safety check)

       Raises:
           400: Invalid domain, confirm not true, or other validation error
           404: Site not found
           503: WordOps command failed
       """
       if not confirm:
           raise HTTPException(
               status_code=status.HTTP_400_BAD_REQUEST,
               detail="Deletion requires confirm=true query parameter",
           )

       if not validate_domain(domain):
           raise HTTPException(
               status_code=status.HTTP_400_BAD_REQUEST,
               detail=f"Invalid domain format: {domain}",
           )

       try:
           await delete_site(domain=domain, force=True)
       except ValueError as e:
           error_msg = str(e).lower()
           if "not found" in error_msg:
               raise HTTPException(
                   status_code=status.HTTP_404_NOT_FOUND,
                   detail=str(e),
               )
           raise HTTPException(
               status_code=status.HTTP_400_BAD_REQUEST,
               detail=str(e),
           )
       except Exception as e:
           raise HTTPException(
               status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
               detail=f"Site deletion failed: {str(e)}",
           )
   ```

The DELETE endpoint requires a `confirm=true` query parameter to prevent accidental deletions.
  </action>
  <verify>
python -c "from backend.wordops.routes import router; methods = {r.path: list(r.methods) if hasattr(r, 'methods') else [] for r in router.routes}; print(f'Routes: {methods}')"
  </verify>
  <done>PUT and DELETE /{domain} endpoints exist with proper validation and error handling</done>
</task>

</tasks>

<verification>
1. Run: `python -c "from backend.wordops.routes import router; print([(r.path, list(r.methods) if hasattr(r, 'methods') else 'N/A') for r in router.routes])"`
   - Expect: PUT and DELETE methods on /{domain} path

2. Code inspection:
   - UpdateSiteRequest has optional ssl, cache, php_version
   - update_site() handles each update type separately
   - delete_site() uses --no-prompt flag
   - DELETE endpoint requires confirm=true query param
</verification>

<success_criteria>
- PUT /api/v1/sites/{domain} endpoint exists for partial updates
- DELETE /api/v1/sites/{domain} endpoint exists with confirm requirement
- update_site() correctly builds WordOps update commands
- delete_site() safely removes sites with --no-prompt
- All endpoints require authentication
- Proper error codes: 400 for validation, 404 for not found, 503 for WordOps errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-site-management/02-04-SUMMARY.md`
</output>
