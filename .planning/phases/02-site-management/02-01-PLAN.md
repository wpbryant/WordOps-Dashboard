---
phase: 02-site-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [backend/wordops/routes.py, backend/main.py]
autonomous: true

must_haves:
  truths:
    - "Authenticated user can list all sites via GET /api/v1/sites"
    - "User can filter sites by type (wordpress, php, html, proxy, mysql)"
    - "User can filter sites by SSL status (true/false)"
    - "User can search sites by domain name substring"
    - "Unauthenticated requests return 401"
  artifacts:
    - path: "backend/wordops/routes.py"
      provides: "Sites API router with list endpoint"
      exports: ["router"]
    - path: "backend/main.py"
      provides: "App with sites router included"
      contains: "include_router"
  key_links:
    - from: "backend/wordops/routes.py"
      to: "backend/wordops/sites.py"
      via: "import list_sites"
      pattern: "from backend\\.wordops\\.sites import list_sites"
    - from: "backend/wordops/routes.py"
      to: "backend/auth/dependencies.py"
      via: "import get_current_user"
      pattern: "from backend\\.auth\\.dependencies import get_current_user"
    - from: "backend/main.py"
      to: "backend/wordops/routes.py"
      via: "include_router"
      pattern: "app\\.include_router\\(sites_router\\)"
---

<objective>
Create the sites API router with a list endpoint that supports filtering and search.

Purpose: Enable authenticated users to retrieve all WordOps-managed sites with optional filters for type, SSL status, and domain search.

Output: `/api/v1/sites` GET endpoint returning filtered site list, protected by JWT authentication.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@backend/wordops/sites.py
@backend/wordops/models.py
@backend/auth/dependencies.py
@backend/auth/routes.py
@backend/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sites router with list endpoint</name>
  <files>backend/wordops/routes.py</files>
  <action>
Create new file backend/wordops/routes.py with:

1. Import dependencies:
   - APIRouter from fastapi
   - Query from fastapi for optional params
   - Depends from fastapi
   - get_current_user from backend.auth.dependencies
   - User from backend.auth.models
   - list_sites from backend.wordops.sites
   - Site, SiteType from backend.wordops.models
   - HTTPException, status from fastapi

2. Create router:
   ```python
   router = APIRouter(prefix="/api/v1/sites", tags=["sites"])
   ```

3. Create GET / endpoint:
   - Dependency: current_user: User = Depends(get_current_user)
   - Query params (all optional):
     - site_type: SiteType | None = Query(None, alias="type")
     - ssl: bool | None = Query(None)
     - search: str | None = Query(None, min_length=1, max_length=253)
   - Response model: list[Site]
   - Implementation:
     a. Call await list_sites()
     b. Filter by site_type if provided: [s for s in sites if s.type == site_type.value]
     c. Filter by ssl if provided: [s for s in sites if s.ssl == ssl]
     d. Filter by search if provided: [s for s in sites if search.lower() in s.name.lower()]
     e. Return filtered list
   - Handle WordOpsError exceptions: return 503 Service Unavailable with error message

Follow the router pattern from backend/auth/routes.py. Use async def for the endpoint.
  </action>
  <verify>
python -c "from backend.wordops.routes import router; print('Router imported successfully')"
  </verify>
  <done>Sites router exists with GET / endpoint accepting type, ssl, and search query params</done>
</task>

<task type="auto">
  <name>Task 2: Register sites router in main app</name>
  <files>backend/main.py</files>
  <action>
Update backend/main.py to include the sites router:

1. Add import:
   ```python
   from backend.wordops.routes import router as sites_router
   ```

2. After the auth_router include, add:
   ```python
   # Include sites routes
   app.include_router(sites_router)
   ```

This follows the existing pattern for auth_router.
  </action>
  <verify>
python -c "from backend.main import app; routes = [r.path for r in app.routes]; assert '/api/v1/sites' in str(routes) or any('/sites' in str(r) for r in routes), 'Sites route not found'; print('Sites router registered')"
  </verify>
  <done>Sites router registered in main.py, /api/v1/sites endpoint accessible</done>
</task>

</tasks>

<verification>
1. Run: `python -c "from backend.main import app; print([r.path for r in app.routes])"`
   - Expect: /api/v1/sites in the route list

2. Static verification:
   - backend/wordops/routes.py exists
   - Router uses get_current_user dependency
   - Query params for type, ssl, search defined
</verification>

<success_criteria>
- GET /api/v1/sites endpoint exists and requires authentication
- Endpoint accepts optional query params: type (SiteType enum), ssl (bool), search (string)
- Endpoint calls list_sites() and applies filters
- Router follows established patterns from auth routes
</success_criteria>

<output>
After completion, create `.planning/phases/02-site-management/02-01-SUMMARY.md`
</output>
