---
phase: 02-site-management
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified: [backend/wordops/sites.py, backend/wordops/models.py, backend/wordops/routes.py]
autonomous: true

must_haves:
  truths:
    - "Authenticated user can create a site via POST /api/v1/sites"
    - "Site creation accepts domain, type, ssl, cache, and php_version options"
    - "Invalid domain format returns 400 Bad Request"
    - "Successful creation returns 201 with created site details"
    - "WordOps create command is called with correct arguments"
  artifacts:
    - path: "backend/wordops/sites.py"
      provides: "create_site() async function"
      contains: "async def create_site"
    - path: "backend/wordops/models.py"
      provides: "CreateSiteRequest Pydantic model"
      contains: "class CreateSiteRequest"
    - path: "backend/wordops/routes.py"
      provides: "POST endpoint for site creation"
      contains: "@router.post"
  key_links:
    - from: "backend/wordops/routes.py"
      to: "backend/wordops/sites.py"
      via: "import create_site"
      pattern: "from backend\\.wordops\\.sites import.*create_site"
    - from: "backend/wordops/sites.py"
      to: "backend/wordops/cli.py"
      via: "run_command(['site', 'create', ...])"
      pattern: "run_command\\(\\[\"site\", \"create\""
---

<objective>
Implement site creation CLI wrapper and API endpoint for creating new WordOps sites.

Purpose: Enable authenticated users to create new WordPress, PHP, HTML, or Proxy sites through the API.

Output: POST `/api/v1/sites` endpoint + `create_site()` function that wraps `wo site create` command.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-site-management/02-02-SUMMARY.md
@backend/wordops/cli.py
@backend/wordops/sites.py
@backend/wordops/models.py
@backend/wordops/routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create site request model</name>
  <files>backend/wordops/models.py</files>
  <action>
Add CreateSiteRequest model to backend/wordops/models.py:

```python
class CacheType(str, Enum):
    """Cache types supported by WordOps."""

    NONE = "none"
    WPFC = "wpfc"      # FastCGI cache
    WPSC = "wpsc"      # WP Super Cache
    WPREDIS = "wpredis"  # Redis object cache
    REDIS = "redis"    # Redis full page cache


class CreateSiteRequest(BaseModel):
    """Request body for creating a new site."""

    domain: str
    type: SiteType = SiteType.WORDPRESS
    ssl: bool = True
    cache: CacheType | None = None
    php_version: str | None = None  # e.g., "8.1", "8.2"

    class Config:
        """Pydantic model configuration."""
        use_enum_values = True
```

Place CacheType enum before CreateSiteRequest. Keep existing Site and SiteType classes unchanged.
  </action>
  <verify>
python -c "from backend.wordops.models import CreateSiteRequest, CacheType; print('Models imported successfully')"
  </verify>
  <done>CreateSiteRequest and CacheType models exist with all site creation options</done>
</task>

<task type="auto">
  <name>Task 2: Implement create_site CLI wrapper</name>
  <files>backend/wordops/sites.py</files>
  <action>
Add create_site() function to backend/wordops/sites.py:

1. Add import for CacheType:
   ```python
   from .models import Site, SiteType, CacheType
   ```

2. Add create_site function after get_site_info():
   ```python
   async def create_site(
       domain: str,
       site_type: SiteType = SiteType.WORDPRESS,
       ssl: bool = True,
       cache: CacheType | None = None,
       php_version: str | None = None,
   ) -> Site:
       """
       Create a new WordOps site.

       Args:
           domain: The domain name for the site
           site_type: Type of site (wordpress, php, html, proxy, mysql)
           ssl: Whether to enable SSL (Let's Encrypt)
           cache: Cache type (wpfc, wpsc, wpredis, redis, none)
           php_version: PHP version (e.g., "8.1", "8.2")

       Returns:
           Site object for the newly created site

       Raises:
           ValueError: If domain validation fails
           CommandFailedError: If site creation fails
       """
       if not validate_domain(domain):
           raise ValueError(f"Invalid domain name: {domain}")

       # Build wo site create command
       args = ["site", "create", domain]

       # Add site type flag
       type_flags = {
           SiteType.WORDPRESS: "--wp",
           SiteType.PHP: "--php",
           SiteType.HTML: "--html",
           SiteType.PROXY: "--proxy",
           SiteType.MYSQL: "--mysql",
       }
       args.append(type_flags.get(site_type, "--wp"))

       # Add cache flag if specified
       if cache and cache != CacheType.NONE:
           cache_flags = {
               CacheType.WPFC: "--wpfc",
               CacheType.WPSC: "--wpsc",
               CacheType.WPREDIS: "--wpredis",
               CacheType.REDIS: "--wpredis",  # Redis uses wpredis flag
           }
           if cache in cache_flags:
               args.append(cache_flags[cache])

       # Add SSL flag
       if ssl:
           args.append("--letsencrypt")

       # Add PHP version if specified
       if php_version:
           # Validate PHP version format
           if not re.match(r"^\d+\.\d+$", php_version):
               raise ValueError(f"Invalid PHP version format: {php_version}")
           args.extend(["--php", php_version])

       # Execute with longer timeout for site creation (can take a while)
       await run_command(args, timeout=300)

       # Fetch and return the created site info
       site = await get_site_info(domain)
       if site is None:
           # Site was created but we couldn't fetch info - return basic info
           return Site(
               name=domain,
               type=site_type,
               ssl=ssl,
               cache=cache.value if cache else None,
               php_version=php_version,
           )

       return site
   ```

The function builds the appropriate `wo site create` command with flags for type, cache, SSL, and PHP version.
  </action>
  <verify>
python -c "from backend.wordops.sites import create_site; import inspect; sig = inspect.signature(create_site); print(f'create_site params: {list(sig.parameters.keys())}')"
  </verify>
  <done>create_site() function exists with domain, type, ssl, cache, php_version parameters</done>
</task>

<task type="auto">
  <name>Task 3: Add create site endpoint</name>
  <files>backend/wordops/routes.py</files>
  <action>
Add POST endpoint to backend/wordops/routes.py:

1. Update imports:
   ```python
   from backend.wordops.sites import list_sites, get_site_info, validate_domain, create_site
   from backend.wordops.models import Site, SiteType, CreateSiteRequest
   ```

2. Add POST / endpoint after the GET /{domain} endpoint:
   ```python
   @router.post("/", response_model=Site, status_code=status.HTTP_201_CREATED)
   async def create_new_site(
       request: CreateSiteRequest,
       current_user: User = Depends(get_current_user),
   ) -> Site:
       """Create a new WordOps site.

       Args:
           request: Site creation parameters

       Returns:
           Created site details

       Raises:
           400: Invalid domain or parameters
           503: WordOps command failed
       """
       # Validate domain format
       if not validate_domain(request.domain):
           raise HTTPException(
               status_code=status.HTTP_400_BAD_REQUEST,
               detail=f"Invalid domain format: {request.domain}",
           )

       try:
           site = await create_site(
               domain=request.domain,
               site_type=SiteType(request.type) if isinstance(request.type, str) else request.type,
               ssl=request.ssl,
               cache=request.cache,
               php_version=request.php_version,
           )
           return site
       except ValueError as e:
           raise HTTPException(
               status_code=status.HTTP_400_BAD_REQUEST,
               detail=str(e),
           )
       except Exception as e:
           raise HTTPException(
               status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
               detail=f"Site creation failed: {str(e)}",
           )
   ```
  </action>
  <verify>
python -c "from backend.wordops.routes import router; methods = [(r.path, r.methods) for r in router.routes if hasattr(r, 'methods')]; print(f'Routes: {methods}')"
  </verify>
  <done>POST / endpoint exists accepting CreateSiteRequest and returning 201 with Site</done>
</task>

</tasks>

<verification>
1. Run: `python -c "from backend.wordops.routes import router; print([(r.path, list(r.methods) if hasattr(r, 'methods') else 'N/A') for r in router.routes])"`
   - Expect: ('/', {'POST'}), ('/', {'GET'}), ('/{domain}', {'GET'})

2. Code inspection:
   - CreateSiteRequest model has domain, type, ssl, cache, php_version fields
   - create_site() builds correct wo command args
   - POST endpoint validates domain and calls create_site()
</verification>

<success_criteria>
- POST /api/v1/sites endpoint exists and requires authentication
- Endpoint accepts CreateSiteRequest body with domain, type, ssl, cache, php_version
- create_site() function correctly builds wo site create command
- Successful creation returns 201 with Site object
- Invalid domain returns 400
- WordOps errors return 503
</success_criteria>

<output>
After completion, create `.planning/phases/02-site-management/02-03-SUMMARY.md`
</output>
