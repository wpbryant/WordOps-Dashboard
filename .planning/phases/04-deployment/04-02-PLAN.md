---
phase: 04-deployment
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - install.sh
autonomous: true

must_haves:
  truths:
    - "User can install dashboard with single curl command"
    - "Installer prompts for domain, admin credentials"
    - "After install, dashboard accessible via HTTPS"
    - "Re-running installer performs upgrade"
  artifacts:
    - path: "install.sh"
      provides: "Complete installation automation"
      min_lines: 100
      contains: "wo site create"
  key_links:
    - from: "install.sh"
      to: "deploy/nginx.conf.template"
      via: "copies to nginx sites-available"
      pattern: "sites-available"
    - from: "install.sh"
      to: "deploy/wo-dashboard.service"
      via: "copies to systemd system directory"
      pattern: "/etc/systemd/system"
    - from: "install.sh"
      to: "deploy/config.env.template"
      via: "substitutes placeholders and writes config"
      pattern: "/etc/wo-dashboard"
---

<objective>
Create installation script that automates complete dashboard deployment including Python environment, configuration, nginx site creation via WordOps, and systemd service setup.

Purpose: Enable one-command installation (`curl ... | bash`) for production servers.
Output: Executable install.sh that handles fresh installs and upgrades.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deployment/04-CONTEXT.md
@.planning/phases/04-deployment/04-01-SUMMARY.md
@deploy/nginx.conf.template
@deploy/wo-dashboard.service
@deploy/config.env.template
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create installation script with environment setup</name>
  <files>install.sh</files>
  <action>
Create bash installation script with proper error handling and idempotency.

Script structure:

1. **Header and checks:**
   - #!/bin/bash with set -e
   - Check running as root (required for systemctl, wo, nginx)
   - Check WordOps is installed (`which wo || exit 1`)
   - Define constants: APP_DIR=/var/www/wo-dashboard, CONFIG_DIR=/etc/wo-dashboard, LOG_DIR=/var/log/wo-dashboard

2. **Detect install mode:**
   - If $APP_DIR exists: upgrade mode (skip prompts that have existing values)
   - Else: fresh install mode

3. **Interactive prompts (fresh install):**
   - Domain name (required): read -p "Enter domain for dashboard: " DOMAIN
   - Admin username (default: admin): read -p "Admin username [admin]: " ADMIN_USER
   - Admin password (required, hidden): read -s -p "Admin password: " ADMIN_PASS
   - Validate inputs (domain not empty, password not empty)

4. **Upgrade prompts:**
   - Ask if user wants to update config (y/n)
   - If yes, prompt for new values; if no, keep existing

5. **Generate credentials:**
   - Generate random SECRET_KEY: openssl rand -hex 32
   - Generate password hash using Python: python3 -c "from passlib.context import CryptContext; print(CryptContext(schemes=['bcrypt']).hash('$ADMIN_PASS'))"

6. **Create directories:**
   - mkdir -p $APP_DIR $CONFIG_DIR $LOG_DIR /run/wo-dashboard
   - Set permissions: chown root:root, chmod 750

7. **Clone/update application:**
   - If fresh: git clone https://github.com/WordOps/WordOps-Dashboard.git $APP_DIR (or appropriate repo URL)
   - If upgrade: cd $APP_DIR && git pull

8. **Python environment:**
   - Create venv if not exists: python3 -m venv $APP_DIR/.venv
   - Upgrade pip: $APP_DIR/.venv/bin/pip install --upgrade pip
   - Install dependencies: $APP_DIR/.venv/bin/pip install -e $APP_DIR

9. **Deploy configuration files:**
   - Copy and substitute nginx.conf.template -> /etc/nginx/sites-available/wo-dashboard-$DOMAIN.conf
   - Copy and substitute wo-dashboard.service -> /etc/systemd/system/wo-dashboard.service
   - Copy and substitute config.env.template -> /etc/wo-dashboard/config.env
   - Use sed for placeholder substitution: sed -e "s/{{DOMAIN}}/$DOMAIN/g" etc.

10. **WordOps site creation (fresh install only):**
    - wo site create $DOMAIN --proxy=127.0.0.1:8000 (WordOps handles SSL automatically)
    - Note: WordOps creates its own nginx config, but we need custom config for rate limiting and WebSocket
    - After wo creates the site, append our custom location blocks or replace the proxy config

11. **Systemd setup:**
    - systemctl daemon-reload
    - systemctl enable wo-dashboard
    - systemctl restart wo-dashboard

12. **Nginx reload:**
    - nginx -t (test config)
    - systemctl reload nginx

13. **Success message:**
    - Print: Dashboard installed at https://$DOMAIN
    - Print: Login with configured admin credentials
    - Print: Logs at /var/log/wo-dashboard/

Include helpful error messages for common failures (WordOps not found, port in use, etc).

IMPORTANT: The script should be well-commented and handle edge cases gracefully. Use functions for major sections to keep it readable.
  </action>
  <verify>install.sh is executable (chmod +x) and passes shellcheck (if available). Script contains all major sections: root check, prompts, venv setup, WordOps site create, systemd enable.</verify>
  <done>Installation script handles fresh install and upgrade with proper WordOps integration</done>
</task>

<task type="auto">
  <name>Task 2: Add uninstall function and documentation</name>
  <files>install.sh</files>
  <action>
Add uninstall capability and inline documentation to the install script.

1. **Add --uninstall flag handling:**
   - Parse $1 for --uninstall flag
   - If --uninstall:
     - Confirm with user (y/n prompt)
     - systemctl stop wo-dashboard
     - systemctl disable wo-dashboard
     - rm /etc/systemd/system/wo-dashboard.service
     - systemctl daemon-reload
     - Read domain from existing config
     - wo site delete $DOMAIN (with --force if needed)
     - rm -rf $APP_DIR $CONFIG_DIR $LOG_DIR
     - Print: "WordOps Dashboard uninstalled"
     - exit 0

2. **Add --help flag:**
   - Print usage: install.sh [--uninstall] [--help]
   - Describe what the script does
   - List prerequisites (root, WordOps installed)

3. **Add inline documentation:**
   - Comment header explaining the script purpose
   - Document each function
   - Note any assumptions (Ubuntu/Debian, WordOps structure)

4. **Add version output:**
   - Print version at start of script (e.g., "WordOps Dashboard Installer v1.0")
  </action>
  <verify>install.sh --help prints usage. Script handles --uninstall flag. Inline comments explain major sections.</verify>
  <done>Installation script complete with uninstall support and documentation</done>
</task>

</tasks>

<verification>
- [ ] install.sh exists and is executable
- [ ] Running as non-root shows appropriate error
- [ ] --help flag works
- [ ] --uninstall flag is handled
- [ ] Script checks for WordOps installation
- [ ] Interactive prompts collect domain, username, password
- [ ] Python venv is created and dependencies installed
- [ ] Config files are deployed with substituted placeholders
- [ ] WordOps is used to create the site with SSL
- [ ] Systemd service is enabled and started
- [ ] Success message shows the dashboard URL
</verification>

<success_criteria>
Complete installation script that:
1. Installs WordOps Dashboard with single command
2. Handles both fresh install and upgrade scenarios
3. Uses WordOps for nginx site creation with SSL
4. Configures systemd for service management
5. Supports uninstallation via --uninstall flag
</success_criteria>

<output>
After completion, create `.planning/phases/04-deployment/04-02-SUMMARY.md`
</output>
