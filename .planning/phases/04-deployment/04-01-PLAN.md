---
phase: 04-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - deploy/nginx.conf.template
  - deploy/wo-dashboard.service
  - deploy/config.env.template
autonomous: true

must_haves:
  truths:
    - "Nginx config proxies requests to uvicorn backend"
    - "Systemd service manages uvicorn lifecycle"
    - "Environment config externalizes all settings"
  artifacts:
    - path: "deploy/nginx.conf.template"
      provides: "Nginx reverse proxy configuration"
      contains: "proxy_pass"
    - path: "deploy/wo-dashboard.service"
      provides: "Systemd unit for service management"
      contains: "[Service]"
    - path: "deploy/config.env.template"
      provides: "Environment variable template"
      contains: "WO_DASHBOARD_"
  key_links:
    - from: "deploy/wo-dashboard.service"
      to: "/etc/wo-dashboard/config.env"
      via: "EnvironmentFile directive"
      pattern: "EnvironmentFile="
    - from: "deploy/nginx.conf.template"
      to: "uvicorn socket"
      via: "proxy_pass directive"
      pattern: "proxy_pass.*unix:|proxy_pass.*127\\.0\\.0\\.1"
---

<objective>
Create deployment configuration files for nginx reverse proxy, systemd service management, and environment-based configuration.

Purpose: Provide reusable templates that the installation script will deploy to production servers.
Output: Three template files in deploy/ directory ready for installation script to use.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-deployment/04-CONTEXT.md
@backend/config.py
@backend/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create nginx reverse proxy template</name>
  <files>deploy/nginx.conf.template</files>
  <action>
Create nginx site configuration template with placeholders for domain name.

Requirements:
- Use {{DOMAIN}} placeholder for the domain (replaced by installer)
- Proxy all requests to uvicorn via unix socket at /run/wo-dashboard/uvicorn.sock
- Set proxy headers: Host, X-Real-IP, X-Forwarded-For, X-Forwarded-Proto
- Enable WebSocket support with Upgrade and Connection headers (needed for log streaming)
- Add rate limiting zone for /api/v1/auth/login (10 requests per minute per IP)
- Do NOT include SSL config - WordOps handles SSL via `wo site create --proxy`
- Include upstream block for the unix socket
- Set appropriate timeouts for long-running operations (proxy_read_timeout 300s for site creation)

Note: This is a template used by the installer. The actual SSL and server block wrapping will be handled by WordOps when creating the site. This config provides the location blocks and proxy settings.
  </action>
  <verify>File exists and contains: upstream, proxy_pass, limit_req_zone, proxy_http_version 1.1</verify>
  <done>Nginx template ready with proxy settings, WebSocket support, and rate limiting</done>
</task>

<task type="auto">
  <name>Task 2: Create systemd service unit and environment template</name>
  <files>deploy/wo-dashboard.service, deploy/config.env.template</files>
  <action>
Create systemd unit file for wo-dashboard service:

Service unit requirements:
- Description: WordOps Dashboard API
- After: network.target
- User: root (needed for systemctl restart and wo CLI)
- WorkingDirectory: /var/www/wo-dashboard
- EnvironmentFile: /etc/wo-dashboard/config.env
- ExecStart: /var/www/wo-dashboard/.venv/bin/uvicorn backend.main:app --uds /run/wo-dashboard/uvicorn.sock
- Restart: on-failure
- RestartSec: 5
- Create RuntimeDirectory=wo-dashboard for socket
- StandardOutput: append:/var/log/wo-dashboard/access.log
- StandardError: append:/var/log/wo-dashboard/error.log

Install section:
- WantedBy: multi-user.target

Create environment config template with all settings from backend/config.py:
- WO_DASHBOARD_SECRET_KEY={{SECRET_KEY}} (placeholder)
- WO_DASHBOARD_DEBUG=false
- WO_DASHBOARD_CORS_ORIGINS=["https://{{DOMAIN}}"]
- WO_DASHBOARD_ACCESS_TOKEN_EXPIRE_MINUTES=60
- WO_DASHBOARD_NETDATA_URL=http://127.0.0.1:19999
- WO_DASHBOARD_ADMIN_USERNAME={{ADMIN_USERNAME}} (placeholder)
- WO_DASHBOARD_ADMIN_PASSWORD_HASH={{ADMIN_PASSWORD_HASH}} (placeholder)

Include comments explaining each setting and how to generate password hash.
  </action>
  <verify>Both files exist. Service file contains [Unit], [Service], [Install] sections. Config template contains all WO_DASHBOARD_ variables.</verify>
  <done>Systemd service unit and environment config template ready for deployment</done>
</task>

</tasks>

<verification>
- [ ] deploy/ directory contains all three template files
- [ ] nginx.conf.template has proxy_pass to unix socket
- [ ] nginx.conf.template has rate limiting for login endpoint
- [ ] nginx.conf.template has WebSocket upgrade headers
- [ ] wo-dashboard.service runs as root
- [ ] wo-dashboard.service uses EnvironmentFile
- [ ] wo-dashboard.service has restart on failure
- [ ] config.env.template has all settings from backend/config.py
- [ ] Templates use clear placeholder syntax ({{VAR}})
</verification>

<success_criteria>
All deployment configuration templates exist in deploy/ directory with correct structure and placeholders ready for the installation script to substitute.
</success_criteria>

<output>
After completion, create `.planning/phases/04-deployment/04-01-SUMMARY.md`
</output>
